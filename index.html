<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pencatatan Keuangan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        /* Tema Dasar */
        :root {
            --bg-color: #f3f4f6;
            --container-bg: rgba(255, 255, 255, 0.7);
            --text-color: #1f2937;
            --card-bg: #f9fafb;
            --input-bg: #f9fafb;
            --border-color: #e5e7eb;
            --gradient-start: #10b981; /* Hijau */
            --gradient-end: #059669; /* Hijau lebih gelap */
        }

        /* Tema Gelap */
        [data-theme='dark'] {
            --bg-color: #111827;
            --container-bg: rgba(31, 41, 55, 0.7);
            --text-color: #f3f4f6;
            --card-bg: #374151;
            --input-bg: #374151;
            --border-color: #4b5563;
            --gradient-start: #047857; /* Hijau tua */
            --gradient-end: #065f46; /* Hijau sangat tua */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            transition: background-color 0.3s;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: linear-gradient(135deg, #a8dadc, #457b9d, #1d3557);
        }
        .container {
            max-width: 600px;
            width: 100%;
            padding: 1.5rem;
            background-color: var(--container-bg);
            border-radius: 1rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .scrollable-history {
            max-height: 400px;
            overflow-y: auto;
        }
        .text-color-primary { color: var(--text-color); }
        .bg-card { background-color: var(--card-bg); transition: background-color 0.3s; }
        .border-color-primary { border-color: var(--border-color); }

        /* Custom Alert */
        #message-box {
            position: fixed;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        #message-box.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Perbaikan untuk visibilitas input pada mode gelap */
        [data-theme='dark'] input {
            color: #111827; /* Mengatur warna teks input menjadi gelap pada mode malam */
        }
        input::placeholder {
            color: #9ca3af;
        }
        [data-theme='dark'] input::placeholder {
            color: #d1d5db;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body data-theme="light" class="flex items-center justify-center min-h-screen">
    
    <div id="message-box" class="bg-red-500 text-white font-medium"></div>

    <div class="container mx-auto p-6 text-color-primary">
        <!-- Tombol Mode Terang/Gelap dan Reset -->
        <div class="flex justify-between items-center mb-4">
            <button id="reset-btn" class="px-4 py-2 text-sm text-gray-700 bg-gray-200 rounded-lg font-semibold hover:bg-gray-300 transition-colors shadow-md dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200">
                Reset
            </button>
            <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 transition-colors">
                <svg id="sun-icon" class="h-6 w-6 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <svg id="moon-icon" class="h-6 w-6 text-gray-400 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
        </div>

        <h1 class="text-3xl font-bold text-center mb-1">Aplikasi Pencatatan Keuangan</h1>
        <p id="user-id-display" class="text-center text-sm mb-4 text-gray-600 dark:text-gray-400">Nomor Pengguna: <span id="user-id">Memuat...</span></p>

        <!-- Input Nomor Pengguna -->
        <div class="p-6 bg-card rounded-xl shadow-inner mb-6">
            <h2 class="text-2xl font-semibold mb-4">Ganti Nomor Pengguna</h2>
            <div class="flex items-center space-x-4">
                <input type="text" id="user-id-input" class="flex-1 px-4 py-2 bg-input border border-color-primary rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-color-primary" placeholder="Masukkan ID Pengguna">
                <button id="load-user-btn" class="px-4 py-2 text-white bg-blue-600 rounded-lg font-semibold hover:bg-blue-700 transition-colors shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Muat Data
                </button>
            </div>
        </div>

        <!-- Bagian Saldo -->
        <div class="mb-6 text-white p-6 rounded-xl shadow-md" style="background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));">
            <h2 class="text-xl font-semibold">Total Saldo</h2>
            <p id="total-saldo" class="text-4xl font-extrabold mt-2">฿ 0.00</p>
            <div class="flex justify-between mt-4 text-sm font-medium">
                <div>
                    <span class="block">Pemasukan</span>
                    <span id="total-pemasukan" class="text-green-200">฿ 0.00</span>
                </div>
                <div>
                    <span class="block">Pengeluaran</span>
                    <span id="total-pengeluaran" class="text-red-200">฿ 0.00</span>
                </div>
            </div>
        </div>

        <!-- Bagian Input Transaksi -->
        <div class="p-6 bg-card rounded-xl shadow-inner mb-6">
            <h2 class="text-2xl font-semibold mb-4">Transaksi Baru</h2>
            <div class="space-y-4">
                <div>
                    <label for="jumlah" class="block text-sm font-medium">Jumlah Transaksi (฿)</label>
                    <input type="text" id="jumlah" class="mt-1 block w-full px-4 py-2 bg-input border border-color-primary rounded-lg shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 text-color-primary" placeholder="Contoh: 50000" inputmode="numeric" pattern="[0-9]*">
                </div>
                <div>
                    <label for="keterangan" class="block text-sm font-medium">Keterangan</label>
                    <input type="text" id="keterangan" class="mt-1 block w-full px-4 py-2 bg-input border border-color-primary rounded-lg shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 text-color-primary" placeholder="Contoh: Belanja Bulanan">
                </div>
                <div class="flex space-x-4">
                    <button id="tambah-btn" class="flex-1 w-full px-4 py-2 text-white bg-green-600 rounded-lg font-semibold hover:bg-green-700 transition-colors shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Tambah Saldo
                    </button>
                    <button id="kurang-btn" class="flex-1 w-full px-4 py-2 text-white bg-red-600 rounded-lg font-semibold hover:bg-red-700 transition-colors shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        Kurangi Saldo
                    </button>
                </div>
            </div>
        </div>

        <!-- Bagian Riwayat Transaksi -->
        <div class="p-6 bg-card rounded-xl shadow-inner">
            <h2 class="text-2xl font-semibold mb-4">Riwayat Transaksi</h2>
            <div id="riwayat-container" class="scrollable-history space-y-4">
                <div id="loading" class="flex justify-center items-center py-8">
                    <div class="spinner"></div>
                </div>
                <div id="riwayat-empty" class="text-center text-gray-500 py-8 hidden">
                    <p class="mb-2">Belum ada transaksi.</p>
                    <p>Mulai catat keuangan Anda!</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, collection, query, onSnapshot, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        document.addEventListener('DOMContentLoaded', () => {
            const totalSaldoEl = document.getElementById('total-saldo');
            const totalPemasukanEl = document.getElementById('total-pemasukan');
            const totalPengeluaranEl = document.getElementById('total-pengeluaran');
            const jumlahInput = document.getElementById('jumlah');
            const keteranganInput = document.getElementById('keterangan');
            const tambahBtn = document.getElementById('tambah-btn');
            const kurangBtn = document.getElementById('kurang-btn');
            const resetBtn = document.getElementById('reset-btn');
            const riwayatContainer = document.getElementById('riwayat-container');
            const riwayatEmptyEl = document.getElementById('riwayat-empty');
            const loadingEl = document.getElementById('loading');
            const themeToggleBtn = document.getElementById('theme-toggle');
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');
            const messageBox = document.getElementById('message-box');
            const userIdDisplayEl = document.getElementById('user-id');
            const userIdInput = document.getElementById('user-id-input');
            const loadUserBtn = document.getElementById('load-user-btn');

            // Global variables for Firebase
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            let db, auth, userId;
            let transactionRef;
            let currentUnsubscribe = null;

            // Function untuk menampilkan pesan di UI
            const showMessage = (message, type = 'error') => {
                messageBox.textContent = message;
                messageBox.classList.remove('bg-red-500', 'bg-green-500');
                messageBox.classList.add(type === 'error' ? 'bg-red-500' : 'bg-green-500', 'show');
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, 3000);
            };

            // Function untuk format angka menjadi Baht Thailand
            const formatBaht = (number) => {
                return new Intl.NumberFormat('th-TH', {
                    style: 'currency',
                    currency: 'THB',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(number);
            };

            // Function untuk merender transaksi di UI
            const renderTransactions = (data) => {
                let totalSaldo = 0;
                let totalPemasukan = 0;
                let totalPengeluaran = 0;
                
                data.forEach(transaksi => {
                    if (transaksi.tipe === 'tambah') {
                        totalPemasukan += transaksi.jumlah;
                    } else {
                        totalPengeluaran += transaksi.jumlah;
                    }
                });
                totalSaldo = totalPemasukan - totalPengeluaran;

                totalSaldoEl.textContent = formatBaht(totalSaldo);
                totalPemasukanEl.textContent = formatBaht(totalPemasukan);
                totalPengeluaranEl.textContent = formatBaht(totalPengeluaran);
                
                riwayatContainer.innerHTML = '';
                if (data.length === 0) {
                    riwayatEmptyEl.style.display = 'block';
                } else {
                    riwayatEmptyEl.style.display = 'none';
                    data.sort((a, b) => b.timestamp - a.timestamp); // Urutkan berdasarkan waktu
                    data.forEach((transaksi) => {
                        const isPositive = transaksi.tipe === 'tambah';
                        const item = document.createElement('div');
                        item.classList.add('flex', 'justify-between', 'items-center', 'p-4', 'rounded-lg', 'shadow-sm', 'transition-all', 'duration-300', isPositive ? 'bg-green-100' : 'bg-red-100', 'dark:bg-gray-700', 'hover:scale-105');
                        
                        // Menyesuaikan warna teks untuk mode gelap pada riwayat
                        const textColorClass = 'dark:text-white';
                        const keteranganColorClass = 'dark:text-gray-300';
                        
                        const mutasiSaldo = isPositive ? transaksi.jumlah : -transaksi.jumlah;

                        item.innerHTML = `
                            <div class="flex-1">
                                <p class="text-lg font-semibold text-gray-800 ${textColorClass}">${transaksi.keterangan}</p>
                                <p class="text-sm text-gray-600 mt-1 ${keteranganColorClass}">${transaksi.tanggal} - ${transaksi.jam}</p>
                            </div>
                            <div class="flex items-center space-x-4">
                                <div class="text-right">
                                    <p class="text-lg font-bold ${isPositive ? 'text-green-700 dark:text-green-400' : 'text-red-700 dark:text-red-400'}">${isPositive ? '+' : '-'} ${formatBaht(transaksi.jumlah)}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-300">Mutasi Saldo: ${formatBaht(mutasiSaldo)}</p>
                                </div>
                                <button data-doc-id="${transaksi.id}" class="delete-btn p-2 rounded-full text-red-600 hover:bg-red-200 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        `;
                        riwayatContainer.appendChild(item);
                    });
                    
                    document.querySelectorAll('.delete-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const docId = e.currentTarget.getAttribute('data-doc-id');
                            deleteTransaction(docId);
                        });
                    });
                }
            };

            // Logika untuk memuat data pengguna berdasarkan ID
            const loadUserData = (newId) => {
                if (!db) {
                    showMessage('Sistem belum siap. Mohon tunggu.');
                    return;
                }

                // Cek apakah ID yang dimasukkan valid (contoh: tidak kosong)
                if (!newId || newId.trim() === '') {
                    showMessage('Mohon masukkan ID Pengguna yang valid.');
                    return;
                }
                
                // Hentikan listener sebelumnya jika ada
                if (currentUnsubscribe) {
                    currentUnsubscribe();
                }

                userId = newId.trim();
                userIdDisplayEl.textContent = userId;
                userIdInput.value = '';

                // Tampilkan spinner loading
                loadingEl.style.display = 'flex';
                riwayatEmptyEl.style.display = 'none';
                
                // Set path Firestore baru
                transactionRef = collection(db, `artifacts/${appId}/users/${userId}/keuangan`);
                
                // Atur listener real-time baru
                currentUnsubscribe = onSnapshot(transactionRef, (snapshot) => {
                    loadingEl.style.display = 'none';
                    const transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderTransactions(transactions);
                }, (error) => {
                    console.error("Error fetching data:", error);
                    showMessage("Gagal memuat data. Periksa koneksi Anda atau pastikan ID pengguna benar.");
                    loadingEl.style.display = 'none';
                    renderTransactions([]);
                });
            };

            // Logika untuk menghapus transaksi dari Firestore
            const deleteTransaction = async (docId) => {
                if (!db || !userId) return;
                try {
                    await deleteDoc(doc(transactionRef, docId));
                    showMessage('Transaksi berhasil dihapus!', 'success');
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    showMessage('Gagal menghapus transaksi.');
                }
            };

            // Logika untuk menangani transaksi dan menyimpannya ke Firestore
            const handleTransaction = async (type) => {
                if (!db || !userId) {
                    showMessage('Mohon muat data pengguna terlebih dahulu.');
                    return;
                }
                const jumlah = parseFloat(jumlahInput.value);
                const keterangan = keteranganInput.value.trim();

                if (isNaN(jumlah) || jumlah <= 0) {
                    showMessage('Mohon masukkan jumlah yang valid.');
                    return;
                }
                
                if (keterangan === '') {
                    showMessage('Mohon masukkan keterangan transaksi.');
                    return;
                }

                const date = new Date();
                const tanggal = date.toLocaleDateString('id-ID', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const jam = date.toLocaleTimeString('id-ID', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                const transaksi = {
                    jumlah: jumlah,
                    keterangan: keterangan,
                    tipe: type,
                    tanggal: tanggal,
                    jam: jam,
                    timestamp: Date.now()
                };
                
                try {
                    await addDoc(transactionRef, transaksi);
                    jumlahInput.value = '';
                    keteranganInput.value = '';
                    showMessage('Transaksi berhasil!', 'success');
                } catch (e) {
                    console.error("Error adding document: ", e);
                    showMessage('Gagal menambahkan transaksi.');
                }
            };

            // Logika untuk mereset semua data di Firestore
            const resetData = async () => {
                if (!db || !userId) return;
                try {
                    const batch = writeBatch(db);
                    const querySnapshot = await getDocs(transactionRef);
                    querySnapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    showMessage('Semua data telah direset!', 'success');
                } catch (e) {
                    console.error("Error resetting data: ", e);
                    showMessage('Gagal mereset data.');
                }
            };

            // Logika untuk mode terang dan gelap
            const toggleTheme = () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateIcons(newTheme);
            };

            const updateIcons = (theme) => {
                if (theme === 'dark') {
                    moonIcon.classList.add('hidden');
                    sunIcon.classList.remove('hidden');
                } else {
                    moonIcon.classList.remove('hidden');
                    sunIcon.classList.add('hidden');
                }
            };
            
            // Inisialisasi tema saat memuat halaman
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateIcons(savedTheme);

            tambahBtn.addEventListener('click', () => handleTransaction('tambah'));
            kurangBtn.addEventListener('click', () => handleTransaction('kurang'));
            resetBtn.addEventListener('click', resetData);
            themeToggleBtn.addEventListener('click', toggleTheme);
            loadUserBtn.addEventListener('click', () => loadUserData(userIdInput.value));

            // Inisialisasi Firebase dan otentikasi
            const initFirebase = async () => {
                try {
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    
                    // Lakukan otentikasi awal dan muat data
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            // Muat data untuk pengguna yang sudah ada
                            loadUserData(user.uid);
                        } else {
                            console.log("Pengguna keluar.");
                            loadingEl.style.display = 'none';
                        }
                    });
                } catch (e) {
                    console.error("Gagal menginisialisasi Firebase:", e);
                    showMessage("Gagal menginisialisasi sistem. Coba segarkan halaman.");
                }
            };

            initFirebase();
        });
    </script>
</body>
</html>
